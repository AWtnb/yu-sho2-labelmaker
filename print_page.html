<!DOCTYPE html>
<!-- thanks https://qiita.com/okoppe8/items/f3b3outere7688c98537512ea -->
<html lang="ja">
<head>
    <meta charset="utf-8"/>
    <title>print-page</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text x=%2250%%22 y=%2250%%22 style=%22dominant-baseline:central;text-anchor:middle;font-size:90px;%22>&#x2714;</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/paper-css/0.3.0/paper.css">
    <link rel="stylesheet" type="text/css" href="./css/print.css">
</head>
<body class="A4">
    <div id="app">
        <div v-for="(sht, idx) in sheetsData" :key="idx">
            <label-sheet :rows="sht"></label-sheet>
        </div>
    </div>
<script src="https://cdn.jsdelivr.net/npm/vue@3.2.37/dist/vue.global.js"></script>
<script>

function toMultiline(s) {
    return (s.length < 1)? "" : s.replace(/[\r?\n]/g, "<br>");
}

function toPhoneNumber(s) {
    return (s.length < 1)? "" : "Tel: " + s;
}


function loadBaseData(){
    const src = window.opener.document.querySelector('#table1 tbody');
    return Array.from(src.rows).map(row => {
        return {
            name:      (toMultiline(row.cells[0].innerText.trim()) || ""),
            honorific: (row.cells[1].innerText.trim() || ""),
            place:     (toMultiline(row.cells[2].innerText.trim()) || ""),
            zipcode:   (row.cells[3].innerText.trim() || ""),
            address:   (toMultiline(row.cells[4].innerText.trim()) || ""),
            phone:     (toPhoneNumber(row.cells[5].innerText.trim()) || ""),
        }
    });
}

class Allocator {
    constructor(basedata) {
        this.nRow = 6;
        this.nCol = 2;
        this.labelLimit = this.nRow * this.nCol;
        this.basedata = basedata;
        this.filled = this.basedata.map((d, i) => ({
            inner: d,
            className: (i == this.basedata.length - 1)? "mark" : "unmark"
        }));
        this.fillRest();
    }

    fillRest(){
        const rest = this.labelLimit - this.basedata.length % this.labelLimit;
        const unit = this.basedata.length;
        for (let i = 0; i < rest; i++) {
            this.filled.push({
                inner: this.basedata[i%unit],
                className: (i % unit == unit - 1)? "mark" : "unmark"
            });
        }
    }

    allocate() {
        const trs = [];
        let cellStack = [];
        for (let i = 0; i < this.filled.length; i++) {
            const label = this.filled[i];
            cellStack.push(label)
            if (cellStack.length == this.nCol || i == this.filled.length - 1) {
                trs.push(cellStack);
                cellStack = [];
            }
        }
        const sheets = [];
        let rowStack = [];
        for (let i = 0; i < trs.length; i++) {
            const tr = trs[i];
            rowStack.push(tr)
            if (rowStack.length == this.nRow || i == trs.length - 1) {
                sheets.push(rowStack);
                rowStack = [];
            }
        }
        return sheets;
    }
}

const labelCell = {
    props: ["label"],
    template: `
    <p class="zipcode">ã€’{{label.zipcode}}</p>
    <div class="container">
        <div class="addressBlock">
            <p class="address">{{label.address}}</p>
            <p class="place">{{label.place}}</p>
            <p class="phone">{{label.phone}}</p>
        </div>
        <div class="nameBlock">
            <p class="name">{{label.name}}<span class="honorific">{{label.honorific}}</span></p>
        </div>
    </div>
    `
}

const labelRow = {
    props: ["labels"],
    components: {
        "label-cell": labelCell
    },
    template: `
    <tr>
        <td v-for="(lb, idx) in labels" :key="idx" :class="lb.className">
            <label-cell :label="lb.inner"></label-cell>
        </td>
    </tr>
    `
}

const labelSheet = {
    props: ["rows"],
    components: {
        "label-row": labelRow
    },
    template: `
    <section class="sheet">
        <table class="print">
            <tbody contenteditable="true">
                <label-row v-for="(r, idx) in rows" :key="idx" :labels="r">
                </label-row>
            </tbody>
        </table>
    </section>
    `
}

const vm = Vue.createApp({
    data: function() {
        return {
            basedata: loadBaseData(),
        }
    },
    computed: {
        sheetsData: function(){
            const alloc = new Allocator(this.basedata);
            return alloc.allocate();
        }
    },
    components: {
        "label-sheet": labelSheet
    }
}).mount("#app");


</script>
</body>
</html>