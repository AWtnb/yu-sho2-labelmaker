<!DOCTYPE html>
<!-- thanks https://qiita.com/okoppe8/items/f3b3outere7688c98537512ea -->
<html lang="ja">
<head>
    <meta charset="utf-8"/>
    <title>print-page</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text x=%2250%%22 y=%2250%%22 style=%22dominant-baseline:central;text-anchor:middle;font-size:90px;%22>&#x2714;</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/paper-css/0.3.0/paper.css">
    <link rel="stylesheet" type="text/css" href="./css/print.css">
</head>
<body class="A4">
    <section class="sheet" id="topSheet">
        <table class="print">
            <tbody contenteditable="true">
                <tr>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                </tr>
            </tbody>
        </table>
    </section>
<script>


const SOURCE_TABLE = window.opener.document.querySelector('#table1 tbody');

function toMultiline(s) {
    return (s.length < 1)? "" : s.replace(/[\r?\n]/g, "<br>");
}

function toPhoneNumber(s) {
    return (s.length < 1)? "" : "Tel: " + s;
}

function loadBaseData(){
    return Array.from(SOURCE_TABLE.rows).map(row => {
        return {
            name:      (toMultiline(row.cells[0].innerText.trim()) || ""),
            honorific: (row.cells[1].innerText.trim() || ""),
            place:     (toMultiline(row.cells[2].innerText.trim()) || ""),
            zipcode:   (row.cells[3].innerText.trim() || ""),
            address:   (toMultiline(row.cells[4].innerText.trim()) || ""),
            phone:     (toPhoneNumber(row.cells[5].innerText.trim()) || ""),
        }
    });
}

function addSection(data) {
    const nSheet = Math.ceil(data.length / 12);
    if (nSheet > 1) {
        const topSheet = document.querySelector("#topSheet");
        for (let n = 0; n < nSheet - 1; n++) {
            const wrapper = document.createElement("section");
            wrapper.innerHTML = topSheet.innerHTML;
            wrapper.classList.add("sheet")
            document.body.appendChild(wrapper);
        }
    }
}

function getLabelMarkup(data) {
    return data.map(d => {
        return `<p class="zipcode">ã€’${d.zipcode}</p>` +
        `<div class="container">` +
            `<div class="addressBlock">` +
                `<p class="address">${d.address}</p>` +
                `<p class="place">${d.place}</p>` +
                `<p class="phone">${d.phone}</p>` +
            `</div>` +
            `<div class="nameBlock">` +
                `<p class="name">${d.name}<span class="honorific">${d.honorific}</span></p>` +
            `</div>` +
        `</div>`;
    });
}

function updateTable(markup) {
    let labelIdx = 0;
    const printTable = document.querySelectorAll(".print");
    for (let i = 0; i < printTable.length; i++) {
        const targetTable = printTable[i];
        const cells = targetTable.querySelectorAll("td");
        for (let c = 0; c < cells.length; c++) {
            cells[c].innerHTML = markup[labelIdx];
            labelIdx += 1;
            if (labelIdx == markup.length) {
                cells[c].style.borderBottomColor = "#ccc";
                cells[c].style.borderRightColor = "#ccc";
                labelIdx = 0;
            }
        }
    }
}

window.onload = function(){
    const data = loadBaseData();

    addSection(data);

    const markup = getLabelMarkup(data);

    updateTable(markup);

}
</script>
</body>
</html>