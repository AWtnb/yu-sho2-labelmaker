<!DOCTYPE html>
<!-- thanks https://qiita.com/okoppe8/items/f3b3e7688c98537512ea -->
<html lang="ja">
<meta charset="utf-8"/>
<head>
    <title>宛名ラベル作成</title>
    <link rel="stylesheet" type="text/css" href="./css/index.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text x=%2250%%22 y=%2250%%22 style=%22dominant-baseline:central;text-anchor:middle;font-size:90px;%22>&#x1F4EB;</text></svg>">
</head>
<body>
<h1>宛名ラベル作成</h1>
<ul>
    <li><strong>注：Internet Explorer 非対応！</strong></li>
    <li>紙に無駄が出ないように、余りが出た場合はリストの先頭からラベルを埋め直します。</li>
    <li>セル内で改行されている場合には正常に動作しません。</li>
</ul>
<img src="img/img_example.png">
<p>下記ボックスに Excel から図のようにコピー＆ペーストしてください。</p>
<form name="form_toImport">
    <textarea name="textarea1" cols="60" rows="5" placeholder="ここにペースト！"></textarea>
</form>

<input type="button" value="下表に読み込む" onclick="clickBtn_import()" />

<table id="table1" contenteditable="true">
    <thead>
        <tr>
            <th>氏名</th>
            <th>敬称</th>
            <th>所属</th>
            <th>郵便番号</th>
            <th>住所</th>
            <th>電話番号</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>福澤 諭吉</td>
            <td>先生</td>
            <td>慶應義塾大学</td>
            <td>108-8345</td>
            <td>東京都港区三田2-15-45</td>
            <td>999-9999-9999</td>
        </tr>
        <tr>
            <td>夏目 漱石</td>
            <td>先生</td>
            <td></td>
            <td>113-0023</td>
            <td>東京都文京区向丘2-20-7</td>
            <td>888-8888-8888</td>
        </tr>
        <tr>
            <td>樋口 一葉</td>
            <td>先生</td>
            <td></td>
            <td>113-0033</td>
            <td>東京都文京区本郷4-32・31</td>
            <td>777-7777-7777</td>
        </tr>
    </tbody>
</table>

<p>※セルを直接編集することもできます。</p>

<input type="button" value="表の内容をラベルに出力！" onclick="openLabel()" />

<script>
function clickBtn_import() {
    const tsv_toImport = document.form_toImport.textarea1.value;
    const tbody = document.querySelector("#table1 tbody");
    resetTable(tbody);
    import2table(tsv_toImport, tbody);
}

function resetTable(tbody){
    const maxRow = tbody.rows.length;
    if (maxRow > 1) {
        for (let r = maxRow - 1; r >= 0; r--) {
            tbody.deleteRow(r);
        }
    }
}

function toHalfWidth(str) {
    return str.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) {
        return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
    });
}

function formatPostalCode(s) {
    return toHalfWidth(s).replace(/^(\d{3})([^\d])?(\d{4})$/, "$1-$3");
}

function fromLine(row, s) {
    let fields = s.split(/\t/g);
    if (fields.length < 6) {
        for (let i = fields.length; i < 6; i++) {
            fields.push("");
        }
    }
    else if (fields.length > 6) {
        fields = fields.slice(0, 6);
    }
    fields.forEach((s, i) => {
        const cell = row.insertCell(i);
        let t = s.trim();
        if (i == 3) {
            t = formatPostalCode(t);
        }
        cell.innerText = toHalfWidth(t);
        cell.style.color = "#343434"
    })
}

function import2table(lines, tbody) {
    lines.split(/[\r\n]+/g).filter(line => line).forEach(line => {
        const row = tbody.insertRow(-1);
        fromLine(row, line);
    });
}

function openLabel() {
    window.open('./print_page.html', 'newwindow', 'width=800,height=890');
}
</script>

<script src="https://cdn.jsdelivr.net/npm/ie-buster@1.1.0/dist/ie-buster.min.js"></script>

</body>

<!-- ========================================
footer
======================================== -->
<footer>
    <p><img src="https://img.icons8.com/small/16/000000/github.png"> <a href="https://github.com/AWtnb/yu-sho2-labelmaker" target="_blank">Github repository</a></p>
</footer>
</html>